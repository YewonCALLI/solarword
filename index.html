<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Word Wide Web</title>

    <link rel="apple-touch-icon" sizes="57x57" href="favicon.io/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="favicon.io/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="favicon.io/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="favicon.io/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="favicon.io/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="favicon.io/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="favicon.io/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="favicon.io/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon.io/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="favicon.io/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="favicon.io/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon.io/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="favicon.io/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Condensed:ital,wght@0,100..900;1,100..900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Sixtyfour+Convergence:SCAN@62&display=swap');

        body {
            display: flex;
            overflow: hidden;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: #fff;
        }

        .input-section {
            position: absolute;
            display: flex;
            gap:8px;
            top: 30px;
            margin-bottom: 20px;
            z-index: 2;
            background: #ffffff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        #center-word-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            margin-top: 20px;
            z-index: 2;
        }

        #center-word-container .word-item {
            background: none;
            text-align: center;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 5px;
        }

        .word-item {
            background: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 20px;
            width: fit-content;
            cursor: pointer;
            transition: background 0.3s;
            margin: 5px;
        }

        .word-item:hover {
            background: #ddd;
        }

        .orbit-word {
            position: absolute;
            transition: transform 0.1s linear;
        }

        #user-sequence-container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
        }

        .ring {
            position: relative;
            width: 2000px;
            height: 2000px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #poem-display {
            position: fixed;
            max-height: 80%;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            padding: 30px;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            min-width: 200px;
            max-width: 400px;
            z-index: 3;
        }

        .poem-title {
            font-size: 24px;
            color: #89CC04;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .connection-line {
            font-size: 20px;
            margin: 12px 0;
            line-height: 1.8;
            color: #4a4a4a;
            transition: all 0.3s ease;
            white-space: pre-wrap;
        }

        .connection-line:hover {
            color: #89CC04;
            transform: scale(1.05);
        }

        .word-item:hover{
            font-size: 24px;
            color: #89CC04;
            transition: all 0.7s ease;
        }

        #word-input, #adjective-input {
            font-family: "Roboto Condensed", sans-serif;
            font-size: 18px;
            padding: 8px 15px;
            border: 2px solid #89CC04;
            border-radius: 8px;
        }

        #word-input {
            width: 200px;
        }

        #adjective-input {
            width: 150px;
        }

        button {
            font-family: "Roboto Condensed", sans-serif;
            font-size: 18px;
            padding: 8px 20px;
            background: #89CC04;
            border: none;
            border-radius: 8px;
            color: rgb(0, 0, 0);
            cursor: pointer;
        }

        button:hover {
            background: #89CC04;
        }

        .poem-description {
            font-size: 14px;
            color: #888;
            margin-top: 20px;
            text-align: center;
            font-style: italic;
        }

        .arrow-path {
            fill: none;
            stroke: black;
            stroke-width: 2;
            marker-end: url(#arrowhead);
        }
        #poem-content{
            overflow-y: scroll;
            overflow-x: hidden;
        }

        .trigger-container{
            font-family: "Sixtyfour Convergence", sans-serif;
            font-optical-sizing: auto;
            font-weight: 400;
            font-style: normal;
            font-variation-settings:
                "BLED" 0,
                "SCAN" 62,
                "XELA" 0,
                "YELA" 0;
            position: absolute;
            bottom:30px;
            display: flex;
            gap:30px;
            z-index: 100;
            cursor: pointer;
        }

        .trigger:hover{
            font-size: larger;
            transition: all 0.7s ease;
        }

        .trigger2:hover{
            font-size: larger;
            transition: all 0.7s ease;
        }


        .trigger2 a{
            color: #000;
            text-decoration: none;
        }


        .iframe-background {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            border: none;
        }

    </style>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
</head>
<body>
    <div class="input-section">
        <input type="text" id="word-input" placeholder="Enter a noun">
        <button onclick="findSimilarWords('noun')">Find Synonym</button>
        <input type="text" id="adjective-input" placeholder="Enter an adjective">
        <button onclick="findSimilarWords('adjective')">Enter Word</button>
    </div>
    <div id="center-word-container"></div>
    <div id="user-sequence-container">
        <div id="user-ring" class="ring"></div>
        <svg id="svg-container" width="2000" height="2000" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" />
                </marker>
            </defs>
        </svg>
    </div>
    <div id="poem-display">
        <div class="poem-title">My Word Chain Rhyme</div>
        <div id="poem-content"></div>
        <div class="poem-description">Based on the Korean nursery rhyme:<br><a href="https://youtu.be/5zlYh8tgeeM?si=krRR88eQZPsimBgc">"The brown monkey's bottom is red..."</a></div>
    </div>
    <div class="trigger-container">
        <div class="trigger" onclick="showIframe()">Open Word Map</div>
        <div class="trigger2"><a href="https://solarword.vercel.app/map.html">Go to see Word Map</a></div>
    </div>
    <iframe id="bgIframe" class="iframe-background" src=""></iframe>


    <script>
        let globalData = [];
        let words = [];
        let centerWord = null;
        let intervalId = null;
        let userSequence = [];
        let userAdjectives = [];
        let baseRadius = 300;
        let visible = false;

        document.addEventListener("DOMContentLoaded", function() {
            Papa.parse('word-scoring-data.csv', {
                download: true,
                header: true,
                dynamicTyping: true,
                complete: function(results) {
                    globalData = results.data.filter(d => d.word);
                }
            });
        });

        function findSimilarWords(inputType) {
    let word;
    if (inputType === 'noun') {
        word = document.getElementById('word-input').value.toString().toLowerCase().trim();
    } else if (inputType === 'adjective') {
        word = document.getElementById('adjective-input').value.toString().toLowerCase().trim();
    } else {
        // 클릭으로 들어온 단어의 경우
        word = inputType.toString().toLowerCase().trim();
    }
    
    if (!word) {
        alert('Please enter a word');
        return;
    }
    
    console.log('Searching for word:', word);
    
    const wordData = globalData.find(d => {
        if (!d.word) return false;
        const dataWord = d.word.toString().toLowerCase().trim();
        const match = dataWord === word;
        if (match) {
            console.log('Found matching word:', dataWord);
        }
        return match;
    });

    if (!wordData) {
        if (inputType === 'noun') {
            document.getElementById('word-input').value = '';
        } else if (inputType === 'adjective') {
            document.getElementById('adjective-input').value = '';
        }
        alert(`"${word}" is not found in our dataset. Please try another word.`);
        return;
    }

    // 단어를 찾은 경우 결과 출력
    console.log('Found word data:', wordData);

    const vectors = globalData.map(d => [
        d['dog-cat'], 
        d['utilitarian-romantic'], 
        d['static-dynamic'],
        d['concrete-intangible'], 
        d['satisfying-irritating'], 
        d['hard-soft']
    ]);

    const wordVector = [
        wordData['dog-cat'],
        wordData['utilitarian-romantic'],
        wordData['static-dynamic'],
        wordData['concrete-intangible'],
        wordData['satisfying-irritating'],
        wordData['hard-soft']
    ];

    const similarities = vectors.map((vector, i) => ({
        word: globalData[i].word,
        similarity: cosineSimilarity(wordVector, vector)
    }));
    
    similarities.sort((a, b) => b.similarity - a.similarity);

    const topSimilarWords = similarities
        .filter(item => {
            if (!item.word) return false;
            const itemWord = item.word.toString().toLowerCase().trim();
            return itemWord !== word;
        })
        .slice(0, 9);

    console.log('Similar words found:', topSimilarWords); // 찾은 유사 단어들 출력

    displayCenterWord(word);
    displayOrbitWords(topSimilarWords);
    addToUserSequence(word);
    
    if (inputType === 'noun') {
        document.getElementById('word-input').value = '';
    } else if (inputType === 'adjective') {
        document.getElementById('adjective-input').value = '';
    }
}

// CSV 파일 로드 시 데이터 확인
document.addEventListener("DOMContentLoaded", function() {
    Papa.parse('word-scoring-data.csv', {
        download: true,
        header: true,
        dynamicTyping: true,
        complete: function(results) {
            globalData = results.data.filter(d => d.word);
            console.log('Data loaded. Total words:', globalData.length);
            console.log('Sample words:', globalData.slice(0, 10).map(d => d.word));
        }
    });
});

function updatePoemDisplay() {
    const poemContainer = document.getElementById('poem-content');
    let poemHtml = '';
    
    for (let i = 0; i < userSequence.length - 1; i++) {
        const currentWord = userSequence[i];
        const nextWord = userSequence[i + 1];
        
        if (i%2==0) {
            // 마지막 줄
            poemHtml += `<div class="connection-line">${currentWord} is ${nextWord}!</div>`;
        } else {
            // 중간 줄들
            poemHtml += `<div class="connection-line">${currentWord} like ${nextWord},</div>`;
        }
    }
    
    poemContainer.innerHTML = poemHtml;
}
        let clickedWord = false;  // 클릭으로 선택했는지 추적

        function displayOrbitWords(similarWords) {
            const container = document.getElementById('center-word-container');
            container.querySelectorAll('.orbit-word').forEach(el => el.remove());

            words = similarWords.map((d, index) => {
                const angle = (2 * Math.PI * index) / similarWords.length;
                const radius = 190;
                const x = radius * Math.cos(angle);
                const y = radius * Math.sin(angle);

                const wordEl = document.createElement('div');
                wordEl.className = 'word-item orbit-word';
                wordEl.style.position = 'absolute';
                wordEl.style.left = '50%';
                wordEl.style.top = '50%';
                wordEl.style.transform = `translate(${x}px, ${y}px) translate(-50%, -50%)`;
                wordEl.textContent = d.word;
                wordEl.onclick = () => {
                    clickedWord = true;
                    console.log(d.word)
                    findSimilarWords(d.word);
                };
                container.appendChild(wordEl);

                return { element: wordEl, angle, radius };
            });

            if (intervalId) clearInterval(intervalId);
            intervalId = setInterval(animateOrbitWords, 100);
        }

        function addToUserSequence(word, adjective) {
            userSequence.push(word);
            userAdjectives.push(adjective);
            document.getElementById('adjective-input').value = '';
            document.getElementById('word-input').value = '';
            clickedWord = false;
            displayUserSequence();
            updatePoemDisplay();
        }


        
        function displayCenterWord(word) {
            const container = document.getElementById('center-word-container');
            container.innerHTML = `<div class="word-item" style="font-size: 32px">${word}</div>`;
            centerWord = word;
        }

        
        function animateOrbitWords() {
            words.forEach(word => {
                word.angle += 0.01;
                const x = word.radius * Math.cos(word.angle);
                const y = word.radius * Math.sin(word.angle);
                word.element.style.transform = `translate(${x}px, ${y}px) translate(-50%, -50%)`;
            });
        }

        function cosineSimilarity(a, b) {
            const dotProduct = a.reduce((sum, val, index) => sum + val * b[index], 0);
            const magnitudeA = Math.sqrt(a.reduce((sum, val) => sum + val * val, 0));
            const magnitudeB = Math.sqrt(b.reduce((sum, val) => sum + val * val, 0));
            return dotProduct / (magnitudeA * magnitudeB);
        }


        function displayUserSequence() {
            const container = document.getElementById('user-ring');
            const svgContainer = document.getElementById('svg-container');
            if (!container || !svgContainer) return;

            container.innerHTML = '';
            svgContainer.innerHTML = `
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" />
                    </marker>
                </defs>
            `;

            const numWords = userSequence.length;
            const numRings = Math.ceil(numWords / 13);
            let scale = 1.8/numRings;
            if (numRings <= 1) scale = 1/numRings;

            document.getElementById('user-sequence-container').style.transform = `translate(-50%, -50%) scale(${scale})`;

            userSequence.forEach((word, index) => {
                const ringIndex = Math.floor(index / 13);
                const angleIncrement = (2 * Math.PI) / 13;
                const angle = -Math.PI / 2 + angleIncrement * (index % 13);
                const radius = baseRadius + ringIndex * 100;
                const x = radius * Math.cos(angle);
                const y = radius * Math.sin(angle);

                const wordEl = document.createElement('div');
                wordEl.className = 'word-item';
                wordEl.style.position = 'absolute';
                wordEl.style.left = `calc(50% + ${x}px)`;
                wordEl.style.top = `calc(50% + ${y}px)`;
                wordEl.textContent = word;
                container.appendChild(wordEl);

                if (index > 0) {
                    const prevAngle = -Math.PI / 2 + angleIncrement * ((index - 1) % 13);
                    const prevRadius = baseRadius + Math.floor((index - 1) / 13) * 100;
                    const prevX = prevRadius * Math.cos(prevAngle);
                    const prevY = prevRadius * Math.sin(prevAngle);

                    const controlX = (1000 + prevX + 1000 + x) / 2 + (prevY - y) * 0.3;
                    const controlY = (1000 + prevY + 1000 + y) / 2 + (x - prevX) * 0.3;

                    const curvePath = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    curvePath.setAttribute('d', `M${1000 + prevX},${1000 + prevY} Q${controlX},${controlY} ${1000 + x},${1000 + y}`);
                    curvePath.classList.add('arrow-path');
                    svgContainer.appendChild(curvePath);

                    if ((index + 1) % 13 === 0 && index !== userSequence.length - 1) {
                        const nextAngle = -Math.PI / 2;
                        const nextRadius = baseRadius + ringIndex * 100;
                        const nextX = nextRadius * Math.cos(nextAngle);
                        const nextY = nextRadius * Math.sin(nextAngle);
                        const nextControlX = (1000 + x + 1000 + nextX) / 2 + (y - nextY) * 0.3;
                        const nextControlY = (1000 + y + 1000 + nextY) / 2 + (nextX - x) * 0.3;
                        const nextCurvePath = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        nextCurvePath.setAttribute('d', `M${1000 + x},${1000 + y} Q${nextControlX},${nextControlY} ${1000 + nextX},${1000 + nextY}`);
                        nextCurvePath.classList.add('arrow-path');
                        svgContainer.appendChild(nextCurvePath);
                    }
                }
            });
        }

        function showIframe() {
            const iframe = document.getElementById('bgIframe');
            visible = !visible;
            
            if (visible) {
                iframe.style.display = 'block';
                iframe.src = 'https://solarword.vercel.app/map.html';
            } else {
                iframe.style.display = 'none';
                iframe.src = '';
            }
        }


        
    </script>
</body>
</html>